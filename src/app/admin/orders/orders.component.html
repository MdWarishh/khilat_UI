<!-- admin/orders/orders.component.html -->
<div class="orders-page">

  <!-- â”€â”€ TOP BAR â”€â”€ -->
  <div class="top-bar">
    <div class="top-bar-left">
      <div class="search-wrap">
        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
        <input class="search-input" type="text" placeholder="Search by order ID, name, email..."
               [(ngModel)]="searchQuery" (input)="applyFilters()">
        <button class="search-clear" *ngIf="searchQuery" (click)="searchQuery=''; applyFilters()">âœ•</button>
      </div>

      <select class="filter-select" [(ngModel)]="filterStatus" (change)="applyFilters()">
        <option value="">All Statuses</option>
        <option *ngFor="let s of allStatuses" [value]="s.value">{{ s.label }}</option>
      </select>

      <select class="filter-select" [(ngModel)]="filterDate" (change)="applyFilters()">
        <option value="">All Time</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
    </div>

    <div class="stat-chips">
      <div class="stat-chip" *ngFor="let s of statusStats" [style.background]="s.bg" [style.color]="s.color">
        <span class="chip-val">{{ s.count }}</span>
        <span class="chip-lbl">{{ s.label }}</span>
      </div>
    </div>
  </div>

  <!-- â”€â”€ ERROR â”€â”€ -->
  <div class="error-alert" *ngIf="error">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    {{ error }}
    <button (click)="error=''">âœ•</button>
  </div>

  <!-- â”€â”€ LOADING â”€â”€ -->
  <div class="loading-wrap" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading orders...</p>
  </div>

  <!-- â”€â”€ TABLE â”€â”€ -->
  <div class="table-card" *ngIf="!loading">

    <div class="table-meta">
      <span class="results-info">
        Showing {{ startIndex + 1 }}â€“{{ endIndex }} of {{ totalElements }} orders
      </span>
      <div class="page-size-wrap">
        <span>Show</span>
        <select [(ngModel)]="pageSize" (change)="onPageSizeChange()">
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
        </select>
        <span>per page</span>
      </div>
    </div>

    <div class="table-wrap" *ngIf="pagedOrders.length > 0">
      <table>
        <thead>
          <tr>
            <th class="sortable" (click)="sort('orderId')">
              Order ID <span class="sort-arrow" [class.active]="sortField==='orderId'">{{ sortDir==='asc'&&sortField==='orderId'?'â†‘':'â†“' }}</span>
            </th>
            <th>Customer</th>
            <th>Phone</th>
            <th class="sortable" (click)="sort('amount')">
              Amount <span class="sort-arrow" [class.active]="sortField==='amount'">{{ sortDir==='asc'&&sortField==='amount'?'â†‘':'â†“' }}</span>
            </th>
            <th>Payment</th>
            <th class="sortable" (click)="sort('createdAt')">
              Date <span class="sort-arrow" [class.active]="sortField==='createdAt'">{{ sortDir==='asc'&&sortField==='createdAt'?'â†‘':'â†“' }}</span>
            </th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let order of pagedOrders; let i = index"
              class="table-row" [style.animation-delay]="(i*0.04)+'s'">

            <td><span class="order-id">#{{ order.orderId }}</span></td>

            <td>
              <div class="customer-cell">
                <span class="customer-name">{{ order.name }}</span>
                <span class="customer-email">{{ order.orderStatus }}</span>
              </div>
            </td>

            <td>
              <span class="guest-id-chip">
                {{ order.phone || 'â€”' }}
              </span>
            </td>

            <td class="price-cell">â‚¹{{ order.amount | number:'1.0-0' }}</td>

            <td>
              <span class="items-chip"
                    [style.background]="order.paymentStatus==='SUCCESS' ? 'rgba(34,197,94,0.1)' : 'rgba(245,158,11,0.1)'"
                    [style.color]="order.paymentStatus==='SUCCESS' ? '#15803d' : '#b45309'">
                {{ order.paymentStatus }}
              </span>
            </td>

            <td class="date-cell">
              <span class="date-main">{{ order.createdAt | date:'dd MMM yyyy' }}</span>
              <span class="date-time">{{ order.createdAt | date:'h:mm a' }}</span>
            </td>

            <td>
              <span class="status-select" [ngClass]="getStatusClass(order.orderStatus)">
                {{ order.orderStatus }}
              </span>
            </td>

            <td>
              <div class="action-btns">
                <button class="btn-icon view" (click)="openDetails(order)" title="View Details">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
                <button class="btn-icon"
                        style="background:rgba(139,92,246,0.1);color:#6d28d9;"
                        (click)="dispatchOrder(order)"
                        [disabled]="order.orderStatus !== 'PENDING' && order.orderStatus !== 'CONFIRMED'"
                        title="Dispatch Order">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
                <button class="btn-icon cancel"
                        (click)="cancelOrder(order)"
                        [disabled]="order.orderStatus === 'CANCELLED' || order.orderStatus === 'DELIVERED' || order.orderStatus === 'DISPATCHED'"
                        title="Cancel Order">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="empty-state" *ngIf="pagedOrders.length === 0 && !loading">
      <span class="empty-icon">ðŸ“¦</span>
      <h3>No orders found</h3>
      <p>Try changing your search or filters</p>
      <button class="btn-clear" (click)="clearFilters()">Clear Filters</button>
    </div>

    <div class="pagination" *ngIf="totalPages > 1">
      <button class="pg-btn" (click)="goToPage(0)"             [disabled]="currentPage===0">Â«</button>
      <button class="pg-btn" (click)="goToPage(currentPage-1)" [disabled]="currentPage===0">â€¹</button>
      <ng-container *ngFor="let pg of pageNumbers">
        <button class="pg-btn"
                [class.active]="pg===currentPage"
                [class.ellipsis]="pg===-1"
                [disabled]="pg===-1"
                (click)="pg!==-1 && goToPage(pg)">
          {{ pg===-1 ? 'â€¦' : displayPage(pg) }}
        </button>
      </ng-container>
      <button class="pg-btn" (click)="goToPage(currentPage+1)" [disabled]="currentPage===totalPages-1">â€º</button>
      <button class="pg-btn" (click)="goToPage(totalPages-1)"  [disabled]="currentPage===totalPages-1">Â»</button>
    </div>

  </div>


  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ORDER DETAILS MODAL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="modal-overlay" *ngIf="showDetails" (click)="showDetails=false">
    <div class="detail-modal" (click)="$event.stopPropagation()">

      <div class="loading-wrap" *ngIf="detailLoading">
        <div class="spinner"></div>
        <p>Loading order details...</p>
      </div>

      <div class="error-alert" *ngIf="detailError && !detailLoading" style="margin:1.5rem">
        {{ detailError }}
        <button (click)="showDetails=false">âœ•</button>
      </div>

      <ng-container *ngIf="selectedOrder && !detailLoading">

        <div class="modal-head">
          <div class="modal-head-left">
            <span class="modal-order-id">#{{ selectedOrder.id }}</span>
            <span class="status-select detail-status" [ngClass]="getStatusClass(selectedOrder.status)">
              {{ selectedOrder.status }}
            </span>
          </div>
          <div class="modal-head-right">
            <button class="btn-cancel-order"
                    *ngIf="selectedOrder.status === 'PENDING' || selectedOrder.status === 'CONFIRMED'"
                    (click)="dispatchOrder(selectedOrder)"
                    style="background:rgba(139,92,246,0.08);color:#6d28d9;border-color:rgba(139,92,246,0.2)">
              ðŸšš Dispatch
            </button>
            <button class="btn-cancel-order"
                    *ngIf="selectedOrder.status !== 'CANCELLED' && selectedOrder.status !== 'DELIVERED' && selectedOrder.status !== 'DISPATCHED'"
                    (click)="cancelOrder(selectedOrder)">
              Cancel Order
            </button>
            <button class="btn-close" (click)="showDetails=false">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
        </div>

        <div class="detail-body">

          <div class="detail-left">

            <div class="detail-section">
              <h4 class="section-title">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                Customer Details
              </h4>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Full Name</span>
                  <span class="info-val">{{ selectedOrder.customerName }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Email</span>
                  <span class="info-val">{{ selectedOrder.customerEmail }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Phone</span>
                  <span class="info-val">{{ selectedOrder.customerPhone || 'â€”' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Guest ID</span>
                  <span class="info-val guest-full">{{ selectedOrder.guestId }}</span>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h4 class="section-title">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                Shipping Address
              </h4>
              <div class="address-box">
                <p>{{ selectedOrder.address }}</p>
              </div>
            </div>

            <div class="detail-section">
              <h4 class="section-title">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                Order Info
              </h4>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Order Date</span>
                  <span class="info-val">{{ selectedOrder.createdAt | date:'dd MMM yyyy, h:mm a' }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Payment</span>
                  <span class="info-val">{{ selectedOrder.paymentMethod || 'Stripe' }}</span>
                </div>
              </div>
            </div>

          </div>

          <div class="detail-right">

            <div class="detail-section">
              <h4 class="section-title">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/></svg>
                Ordered Items ({{ selectedOrder.orderItems?.length || 0 }})
              </h4>

              <div class="items-list">
                <div class="order-item" *ngFor="let item of selectedOrder.orderItems">
                  <div class="order-item-img">
                    <img *ngIf="item.imageUrl" [src]="item.imageUrl" [alt]="item.productName"
                         onerror="this.onerror=null;this.style.display='none'">
                    <span *ngIf="!item.imageUrl">ðŸ‘—</span>
                  </div>
                  <div class="order-item-info">
                    <span class="oi-name">{{ item.productName }}</span>
                    <span class="oi-meta">Qty: {{ item.quantity }} Ã— â‚¹{{ item.price }}</span>
                  </div>
                  <span class="oi-total">â‚¹{{ item.quantity * item.price | number:'1.0-0' }}</span>
                </div>
              </div>

              <div class="price-summary">
                <div class="ps-row">
                  <span>Subtotal</span>
                  <span>â‚¹{{ getSubtotal(selectedOrder) | number:'1.0-0' }}</span>
                </div>
                <div class="ps-row">
                  <span>Shipping</span>
                  <span *ngIf="selectedOrder.shippingCharge === 0" class="free-text">FREE</span>
                  <span *ngIf="selectedOrder.shippingCharge > 0">â‚¹{{ selectedOrder.shippingCharge }}</span>
                </div>
                <div class="ps-divider"></div>
                <div class="ps-row total-row">
                  <span>Total</span>
                  <span class="total-price">â‚¹{{ selectedOrder.totalAmount | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h4 class="section-title">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                Status Timeline
              </h4>
              <div class="timeline">
                <div *ngFor="let step of getTimeline(selectedOrder.status)"
                     class="timeline-step" [class.done]="step.done" [class.current]="step.current">
                  <div class="tl-dot"></div>
                  <div class="tl-info">
                    <span class="tl-label">{{ step.label }}</span>
                    <span class="tl-sub" *ngIf="step.current">Current status</span>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

      </ng-container>
    </div>
  </div>

</div>