<div class="checkout-page">
  <div class="checkout-container">

    <h1 class="page-title">Checkout</h1>

    <!-- Step indicators -->
    <div class="step-indicators">
      <div class="step" [class.active]="currentStep === 1" [class.done]="currentStep === 2">
        <span class="step-num">1</span>
        <span class="step-label">Shipping Details</span>
      </div>
      <div class="step-line" [class.done]="currentStep === 2"></div>
      <div class="step" [class.active]="currentStep === 2">
        <span class="step-num">2</span>
        <span class="step-label">Payment</span>
      </div>
    </div>

    <div class="checkout-layout">

      <!-- ‚îÄ‚îÄ‚îÄ LEFT COLUMN ‚îÄ‚îÄ‚îÄ -->
      <div class="left-col">

        <!-- STEP 1: Shipping Form -->
        <div class="shipping-form" *ngIf="currentStep === 1">
          <div class="section-header">
            <h2>Shipping & Billing Details</h2>
          </div>

          <form (ngSubmit)="onSubmit()" #checkoutForm="ngForm">

            <div class="form-group">
              <label>Full Name <span class="required">*</span></label>
              <input type="text" [(ngModel)]="form.fullName" name="fullName"
                     [class.invalid]="formSubmitted && !form.fullName"
                     placeholder="Enter your full name">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Email <span class="required">*</span></label>
                <input type="email" [(ngModel)]="form.email" name="email"
                       [class.invalid]="formSubmitted && (!form.email || !isValidEmail(form.email))"
                       placeholder="you@example.com">
              </div>
              <div class="form-group">
                <label>Phone <span class="required">*</span></label>
                <input type="tel" [(ngModel)]="form.phone" name="phone" maxlength="10"
                       [class.invalid]="formSubmitted && (!form.phone || !isValidPhone(form.phone))"
                       placeholder="10-digit mobile number">
              </div>
            </div>

            <div class="form-group">
              <label>Address Line 1 <span class="required">*</span></label>
              <input type="text" [(ngModel)]="form.addressLine1" name="addressLine1"
                     [class.invalid]="formSubmitted && !form.addressLine1"
                     placeholder="House no, Street name">
            </div>

            <div class="form-group">
              <label>Address Line 2 <span class="optional">(optional)</span></label>
              <input type="text" [(ngModel)]="form.addressLine2" name="addressLine2"
                     placeholder="Landmark, Area">
            </div>

            <div class="form-row form-row-3">
              <div class="form-group">
                <label>City <span class="required">*</span></label>
                <input type="text" [(ngModel)]="form.city" name="city"
                       [class.invalid]="formSubmitted && !form.city"
                       placeholder="City">
              </div>
              <div class="form-group">
                <label>State <span class="required">*</span></label>
                <input type="text" [(ngModel)]="form.state" name="state"
                       [class.invalid]="formSubmitted && !form.state"
                       placeholder="State">
              </div>
              <div class="form-group">
                <label>Pincode <span class="required">*</span></label>
                <input type="text" [(ngModel)]="form.pincode" name="pincode"
                       maxlength="6"
                       [class.invalid]="formSubmitted && (!form.pincode || form.pincode.length !== 6)"
                       placeholder="6-digit pincode">
              </div>
            </div>

            <div class="error-msg" *ngIf="errorMessage">{{ errorMessage }}</div>

            <button type="submit" class="btn-proceed" [disabled]="loading">
              <span *ngIf="!loading">Continue to Payment ‚Üí</span>
              <span *ngIf="loading" class="loading-text">
                <span class="spinner"></span> Creating order...
              </span>
            </button>

          </form>
        </div>

        <!-- STEP 2: Stripe Payment -->
        <div class="payment-form" *ngIf="currentStep === 2">
          <div class="section-header payment-header">
            <button class="btn-back" (click)="goBackToForm()">‚Üê Back</button>
            <h2>Secure Payment</h2>
          </div>

          <!-- Shipping summary (read-only) -->
          <div class="address-summary">
            <div class="address-icon">üì¶</div>
            <div>
              <strong>{{ form.fullName }}</strong>
              <p>{{ form.addressLine1 }}<span *ngIf="form.addressLine2">, {{ form.addressLine2 }}</span></p>
              <p>{{ form.city }}, {{ form.state }} - {{ form.pincode }}</p>
              <p>{{ form.phone }} | {{ form.email }}</p>
            </div>
          </div>

          <!-- Stripe Payment Element mounts here -->
          <div id="stripe-payment-element" class="stripe-element-wrapper">
            <div class="stripe-loading" *ngIf="!stripeReady">
              <span class="spinner"></span> Loading payment form...
            </div>
          </div>

          <div class="error-msg" *ngIf="errorMessage">{{ errorMessage }}</div>

          <button class="btn-proceed btn-pay" (click)="confirmPayment()"
                  [disabled]="stripeLoading || !stripeReady">
            <span *ngIf="!stripeLoading">
              üîí Pay ‚Çπ{{ total }}
            </span>
            <span *ngIf="stripeLoading" class="loading-text">
              <span class="spinner"></span> Processing payment...
            </span>
          </button>

          <p class="secure-note">üîí Your payment is secured by Stripe. We never store card details.</p>
        </div>

      </div>

      <!-- ‚îÄ‚îÄ‚îÄ RIGHT COLUMN: Order Summary ‚îÄ‚îÄ‚îÄ -->
      <div class="order-summary">
        <div class="summary-header">
          <h3>Order Summary</h3>
        </div>

        <div class="items-list">
          <div class="summary-item" *ngFor="let item of cartItems">
            <div class="item-info">
              <span class="item-name">{{ getProductName(item) }}</span>
              <span class="item-qty">Qty: {{ getProductQty(item) }}</span>
            </div>
            <span class="item-price">‚Çπ{{ getItemTotal(item) }}</span>
          </div>
        </div>

        <div class="summary-totals">
          <div class="total-row">
            <span>Subtotal</span>
            <span>‚Çπ{{ subtotal }}</span>
          </div>
          <div class="total-row">
            <span>Shipping</span>
            <span *ngIf="shipping === 0" class="free">FREE</span>
            <span *ngIf="shipping > 0">‚Çπ{{ shipping }}</span>
          </div>
          <div class="total-row grand-total">
            <span>Total</span>
            <span>‚Çπ{{ total }}</span>
          </div>
        </div>

        <div class="free-shipping-msg" *ngIf="subtotal < 999">
          Add ‚Çπ{{ 999 - subtotal }} more for free shipping üöö
        </div>
      </div>

    </div>
  </div>
</div>